import logging
from rex.exploit import Shellcodes, NoSuchShellcode

l = logging.getLogger("rex.exploit.shellcode_factory")

class ShellcodeFactory(object):
    '''
    Shellcode manager object, manages preferences for shellcode types and in the future, their options
    '''

    DEFAULT_SHELLCODES = {'cgc': 'set_register', 'unix': 'binsh'}

    def __init__(self, project):
        '''
        :param project: a project option to base shellcode retrieve decisions off of
        '''
        self.os = project.loader.main_bin.os
        self.arch = project.arch.name
        self.default = dict(ShellcodeFactory.DEFAULT_SHELLCODES)

    def get_default(self, **kwargs):
        '''
        retrieve the default shellcode as a raw string
        '''
        payload_name = self.default[self.os]
        sc = Shellcodes[self.os][self.arch][payload_name]()
        return sc.to_raw(**kwargs)

    def set_default(self, new_default):
        '''
        set a new default shellcode
        '''
        if not new_default in Shellcodes[self.os][self.arch]:
            raise NoSuchShellcode("shellcode by name '%s' for os '%s' and arch '%s'" % (payload_name, self.arch))
        self.default[self.os] = new_default

    def get_shellcode(self, payload_name, **kwargs):
        '''
        grab a shellcode with a known name
        '''
        try:
            sc = Shellcodes[self.os][self.arch][payload_name]()
        except KeyError:
            raise NoSuchShellcode("shellcode by name '%s' for os '%s' and arch '%s'" % (payload_name, self.os, self.arch))
        return sc.to_raw(**kwargs)
