import angr
import angrop
import logging
from rex import Vulnerability
from rex.exploit import Exploit, CannotExploit
from ..technique import Technique

l = logging.getLogger("rex.exploit.techniques.cgc.rop_set_register")

class RopSetRegister(Technique):

    name = "rop_set_register"

    applicable_to = ['cgc']
    cgc_registers = ["eax", "ecx", "edx", "ebx", "esp", "ebp", "esi", "edi"]

    def set_register(self, register):
        #pylint:disable=arguments-differ

        ct = self.crash.crash_type
        if ct == Vulnerability.IP_OVERWRITE or ct == Vulnerability.PARTIAL_IP_OVERWRITE:
            try:
                # get a chain with a dummy value
                chain = self.rop.set_regs(**{register: 0x41414141})
            except angrop.errors.RopException:
                raise CannotExploit("[%s] no rop chains which set the registers %s" % (self.name, register))

            _, chain_addr, _ = self._ip_overwrite_with_chain(chain)

            # place the chain onto chain_addr
            chain_mem = self.crash.state.memory.load(chain_addr, len(chain.payload_str()))
            chain_bvv = self.crash.state.se.BVV(chain.payload_str())
            self.crash.state.add_constraints(chain_mem == chain_bvv)

            l.info("exploit for register %s", register)
            return Exploit(self.crash)

    def apply(self, **kwargs):

        exploits = [ ]
        for register in RopSetRegister.cgc_registers:
            try:
                exploits.append(self.set_register(register))
            except CannotExploit:
                l.warning("unable to set register %s, no rop chain to do so", register)

        __import__("ipdb").set_trace()
