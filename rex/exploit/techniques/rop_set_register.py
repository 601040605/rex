import angrop
import claripy
import logging
from rex import Vulnerability
from rex.exploit import CannotExploit
from ..exploit import ExploitException
from ..cgc import CGCType1RopExploit
from ..technique import Technique

l = logging.getLogger("rex.exploit.techniques.rop_set_register")

class RopSetRegister(Technique):
    '''
    Very CGC specific register setting technique, does a lot of special stuff to make sure the value the register is
    set to is flexible.
    '''

    name = "rop_set_register"

    applicable_to = ['cgc']

    cgc_registers = ["eax", "ecx", "edx", "ebx", "esp", "ebp", "esi", "edi"]

    # this technique should create an exploit which is a type1 pov
    pov_type = 1

    generates_pov = True

    def set_register(self, register):
        #pylint:disable=arguments-differ

        ct = self.crash.crash_type
        if not (ct == Vulnerability.IP_OVERWRITE or ct == Vulnerability.PARTIAL_IP_OVERWRITE):
            raise CannotExploit("can only apply this technique to ip overwrite vulnerabilities")

        value_var = claripy.BVS('set_value', self.crash.project.arch.bits)
        try:
            # get a chain with a dummy value
            chain = self.rop.set_regs(**{register: value_var})
        except angrop.errors.RopException:
            raise CannotExploit("[%s] no rop chains which set the registers %s" % (self.name, register))

        chain, chain_addr = self._ip_overwrite_with_chain(chain)

        l.debug("attempting to insert chain of length %d", len(chain.payload_str()))

        # wrapped because in weird cases inserting the chain can faitl
        try:
            # the chain has to be set by our Type1Exploit, who in turn has to figure out which bytes are the
            # value so we can compile this exploit to a CGC binary
            return CGCType1RopExploit(self.crash, register, chain_addr, chain, value_var)
        except ExploitException as e:
            raise CannotExploit(e.message)

    def apply(self, **kwargs):

        for register in RopSetRegister.cgc_registers:
            try:
                reg_setter = self.set_register(register)
                l.info("can set register [%s] with rop", register)
                return reg_setter
            except CannotExploit as e:
                l.debug("unable to set register %s (%s)", register, e.message)
